# H·ªÜ TH·ªêNG GI√ÅM S√ÅT D·ªÆ LI·ªÜU (DATA MONITORING SYSTEM)

## M·ª§C L·ª§C

1.  [T·ªîNG QUAN H·ªÜ TH·ªêNG](#1-t%E1%BB%95ng-quan-h%E1%BB%87-th%E1%BB%91ng)
2.  [C·∫§U TR√öC TH∆Ø M·ª§C](#2-c%E1%BA%A5u-tr%C3%BAc-th%C6%B0-m%E1%BB%A5c)
3.  [C·∫§U H√åNH (CONFIG FILES)](#3-c%E1%BA%A5u-h%C3%ACnh-config-files)
4.  [C√ÅC MODULE KI·ªÇM TRA](#4-c%C3%A1c-module-ki%E1%BB%83m-tra)
5.  [TI·ªÜN √çCH (UTILITIES)](#5-ti%E1%BB%87n-%C3%ADch-utilities)
6.  [C√ÅCH CH·∫†Y H·ªÜ TH·ªêNG](#6-c%C3%A1ch-ch%E1%BA%A1y-h%E1%BB%87-th%E1%BB%91ng)
7.  [DYNAMIC CONFIG RELOAD](#7-dynamic-config-reload)
8.  [TASK LIFECYCLE MANAGEMENT](#8-task-lifecycle-management)
9.  [H·ªÜ TH·ªêNG C·∫¢NH B√ÅO](#9-h%E1%BB%87-th%E1%BB%91ng-c%E1%BA%A3nh-b%C3%A1o)
10.  [Y√äU C·∫¶U H·ªÜ TH·ªêNG](#10-y%C3%AAu-c%E1%BA%A7u-h%E1%BB%87-th%E1%BB%91ng)

---

## 1. T·ªîNG QUAN H·ªÜ TH·ªêNG

H·ªá th·ªëng gi√°m s√°t d·ªØ li·ªáu ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ theo d√µi t√≠nh c·∫≠p nh·∫≠t (freshness) c·ªßa d·ªØ li·ªáu t·ª´ 3 ngu·ªìn kh√°c nhau:

-   API endpoints (check_api)
-   Database collections/tables (check_database)
-   File/Folder tr√™n disk (check_disk)

**ƒê·∫∑c ƒëi·ªÉm ch√≠nh:**

-   Ch·∫°y b·∫•t ƒë·ªìng b·ªô (asyncio) v·ªõi nhi·ªÅu tasks song song
-   Config ƒë·ªông reload m·ªói 10 gi√¢y kh√¥ng c·∫ßn restart
-   Qu·∫£n l√Ω task lifecycle t·ª± ƒë·ªông (start/stop khi config thay ƒë·ªïi)
-   C·∫£nh b√°o qua Discord webhook
-   Ph√°t hi·ªán ng√†y l·ªÖ th√¥ng minh (nhi·ªÅu item c√πng stale)

---

## 2. C·∫§U TR√öC TH∆Ø M·ª§C

```
check_data_project/‚îÇ‚îú‚îÄ‚îÄ configs/                        # Th∆∞ m·ª•c ch·ª©a t·∫•t c·∫£ config files‚îÇ   ‚îú‚îÄ‚îÄ common_config.json         # Platform info + DB credentials‚îÇ   ‚îú‚îÄ‚îÄ check_api_config.json      # Config cho API monitoring‚îÇ   ‚îú‚îÄ‚îÄ check_database_config.json # Config cho Database monitoring‚îÇ   ‚îú‚îÄ‚îÄ check_disk_config.json     # Config cho Disk monitoring‚îÇ   ‚îî‚îÄ‚îÄ logging_config.py          # C·∫•u h√¨nh logging‚îÇ‚îú‚îÄ‚îÄ src/‚îÇ   ‚îú‚îÄ‚îÄ main.py                    # Entry point ch√≠nh‚îÇ   ‚îÇ‚îÇ   ‚îú‚îÄ‚îÄ check_api/‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ check_api.py           # Module ki·ªÉm tra API endpoints‚îÇ   ‚îÇ‚îÇ   ‚îú‚îÄ‚îÄ check_database/‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ check_database.py      # Module ki·ªÉm tra Database‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database_config.py     # K·∫øt n·ªëi DB (MongoDB, PostgreSQL)‚îÇ   ‚îÇ‚îÇ   ‚îú‚îÄ‚îÄ check_disk/‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ check_disk.py          # Module ki·ªÉm tra Files/Folders‚îÇ   ‚îÇ‚îÇ   ‚îî‚îÄ‚îÄ utils/‚îÇ       ‚îú‚îÄ‚îÄ convert_datetime_util.py  # Chuy·ªÉn ƒë·ªïi datetime v√† timezone‚îÇ       ‚îú‚îÄ‚îÄ load_config_util.py       # Load JSON config v·ªõi caching‚îÇ       ‚îî‚îÄ‚îÄ platform_util.py          # Platform-specific utilities‚îÇ‚îú‚îÄ‚îÄ docs/‚îÇ   ‚îî‚îÄ‚îÄ system_design.drawio       # S∆° ƒë·ªì thi·∫øt k·∫ø h·ªá th·ªëng‚îÇ‚îú‚îÄ‚îÄ requirements.txt               # Python dependencies‚îî‚îÄ‚îÄ README.md                      # File t√†i li·ªáu n√†y
```

---

## 3. C·∫§U H√åNH (CONFIG FILES)

T·∫•t c·∫£ config files ƒë·ªÅu ·ªü d·∫°ng JSON v√† n·∫±m trong th∆∞ m·ª•c `configs/`

### 3.1. common_config.json

Ch·ª©a th√¥ng tin chung: platform info v√† credentials cho c√°c database

**C·∫•u tr√∫c:**

```json
{  "PLATFORM_CONFIG": {    "WEBHOOK_URL": "https://discord.com/api/webhooks/...",    "DESCRIPTION": "T√™n m√¥i tr∆∞·ªùng (vd: VPS, Local, Production)"  },  "POSTGRE_CONFIG": {    "host": "hostname",    "port": 5432,    "database": "db_name",    "user": "username",     "password": "password"  },  "MONGO_CONFIG": {    "host": "hostname",    "port": 27017,    "database": "db_name",    "username": "username",    "password": "password"  }}
```

**S·ª≠ d·ª•ng:**

-   database_config.py: ƒê·ªçc credentials ƒë·ªÉ t·∫°o k·∫øt n·ªëi DB
-   `platform_util.py`: ƒê·ªçc PLATFORM_CONFIG ƒë·ªÉ get webhook URL
-   T·∫•t c·∫£ modules: L·∫•y th√¥ng tin platform cho alerts

### 3.2. check_api_config.json

C·∫•u h√¨nh c√°c API endpoints c·∫ßn gi√°m s√°t

**C·∫•u tr√∫c m·ªói item:**

```json
{  "api-name": {    "auto_sync_symbols": true,      // true: t·ª± ƒë·ªông l·∫•y t·ª´ DB, false: nh·∫≠p th·ªß c√¥ng, null: kh√¥ng c·∫ßn symbols    "symbols": ["SYMBOL1", "..."],  // List symbols (b·∫Øt bu·ªôc n·∫øu auto_sync_symbols=false)    "uri": "https://...",           // URL ƒë·∫ßy ƒë·ªß c·ªßa API endpoint    "record_pointer": 0,            // Index ho·∫∑c path ƒë·∫øn record c·∫ßn check    "column_to_check": "datetime",  // Column ch·ª©a timestamp    "timezone_offset": 0,           // Offset timezone (0=UTC, 7=VN)    "allow_delay": 60,              // ƒê·ªô tr·ªÖ cho ph√©p (gi√¢y)    "check_frequency": 60,          // Kho·∫£ng th·ªùi gian check (gi√¢y)    "alert_frequency": 60,          // T·∫ßn su·∫•t g·ª≠i alert (gi√¢y)    "valid_schedule": null          // Gi·ªù ho·∫°t ƒë·ªông (null = 24/7)  }}
```

**Gi·∫£i th√≠ch parameters:**

**auto_sync_symbols** (B·∫ÆT BU·ªòC - ph·∫£i c√≥ trong m·ªçi config):

-   `true`: T·ª± ƒë·ªông l·∫•y symbols t·ª´ database
    -   Y√™u c·∫ßu: Ph·∫£i c√≥ database config c√πng t√™n v·ªõi `symbol_column` ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
    -   B·ªè qua field `symbols` n·∫øu c√≥
    -   V√≠ d·ª•: API "cmc" s·∫Ω t·ª± ƒë·ªông query database "cmc" ƒë·ªÉ l·∫•y distinct symbols
-   `false`: S·ª≠ d·ª•ng symbols ƒë∆∞·ª£c nh·∫≠p th·ªß c√¥ng
    -   Y√™u c·∫ßu: Ph·∫£i c√≥ field `symbols` v·ªõi list symbols
    -   N·∫øu thi·∫øu `symbols`: H·ªá th·ªëng c·∫£nh b√°o v√† skip API
-   `null`: API kh√¥ng c·∫ßn symbols (single data source)
    -   V√≠ d·ª•: "gold-data" ch·ªâ c√≥ 1 ngu·ªìn d·ªØ li·ªáu, kh√¥ng c√≥ nhi·ªÅu symbols

**symbols** (B·∫ÆT BU·ªòC):

-   N·∫øu `auto_sync_symbols=true`: Set `null` (s·∫Ω t·ª± ƒë·ªông l·∫•y t·ª´ DB)
-   N·∫øu `auto_sync_symbols=false`: List c√°c symbols c·∫ßn check: `["ETH", "BNB", "XRP"]`
-   N·∫øu `auto_sync_symbols=null`: Set `null`

**uri**: URL endpoint tr·∫£ v·ªÅ JSON data

-   C√≥ th·ªÉ ch·ª©a placeholder `{symbol}` n·∫øu API c·∫ßn symbol parameter
-   V√≠ d·ª•: `"http://api.example.com/data?symbol={symbol}"`

**record_pointer**: Index ho·∫∑c path ƒë·∫øn record c·∫ßn check trong response

-   `0`: L·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n c·ªßa array
-   `"data.records"`: L·∫•y t·ª´ nested object

**column_to_check**: T√™n field ch·ª©a timestamp trong response

**timezone_offset**: Ch√™nh l·ªách timezone so v·ªõi UTC

-   `0`: UTC
-   `7`: Vietnam (UTC+7)
-   `-5`: US Eastern (UTC-5)

**allow_delay**: D·ªØ li·ªáu c≈© qu√° bao nhi√™u gi√¢y th√¨ c·∫£nh b√°o

-   V√≠ d·ª•: `60` = c·∫£nh b√°o n·∫øu data c≈© h∆°n 1 ph√∫t

**check_frequency**: M·ªói bao nhi√™u gi√¢y check 1 l·∫ßn

**alert_frequency**: T·∫ßn su·∫•t g·ª≠i alert (ƒë·ªÉ tr√°nh spam)

-   Ch·ªâ g·ª≠i alert m·ªói X gi√¢y n·∫øu data v·∫´n c√≤n stale

**valid_schedule**: L·ªãch ho·∫°t ƒë·ªông

-   `null`: Ch·∫°y 24/7
-   Object v·ªõi `days` v√† `hours`:
    
    ```json
    {  "days": [0, 1, 2, 3, 4],        // 0=Mon, 6=Sun  "hours": ["09:00-11:30", "13:00-14:30"]}
    ```
    

**V√≠ d·ª• 1: Auto sync symbols t·ª´ database**

```json
{  "cmc": {    "auto_sync_symbols": true,    "symbols": null,    "uri": "http://192.168.110.164:8010/crypto/cmc/?symbol={symbol}&day=0",    "record_pointer": 0,    "column_to_check": "datetime",    "timezone_offset": 0,    "allow_delay": 1800,    "check_frequency": 60,    "alert_frequency": 60,    "valid_schedule": null  }}
```

‚Üí H·ªá th·ªëng t·ª± ƒë·ªông query database "cmc" ƒë·ªÉ l·∫•y danh s√°ch symbols

**V√≠ d·ª• 2: Nh·∫≠p symbols th·ªß c√¥ng**

```json
{  "binance-futures": {    "auto_sync_symbols": false,    "symbols": ["BTCUSDT", "ETHUSDT", "BNBUSDT"],    "uri": "https://api.example.com/futures?symbol={symbol}",    "record_pointer": 0,    "column_to_check": "timestamp",    "timezone_offset": 0,    "allow_delay": 120,    "check_frequency": 60,    "alert_frequency": 300,    "valid_schedule": null  }}
```

‚Üí S·ª≠ d·ª•ng 3 symbols ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a s·∫µn

**V√≠ d·ª• 3: API kh√¥ng c·∫ßn symbols**

```json
{  "gold-data": {    "auto_sync_symbols": null,    "symbols": null,    "uri": "http://192.168.110.164:8010/gold-data/?day=0",    "record_pointer": 0,    "column_to_check": "datetime",    "timezone_offset": 7,    "allow_delay": 70,    "check_frequency": 10,    "alert_frequency": 60,    "valid_schedule": {      "days": [0, 1, 2, 3, 4],      "hours": ["00:00-23:59"]    }  }}
```

‚Üí Ch·ªâ t·∫°o 1 task duy nh·∫•t cho API n√†y

### 3.3. check_database_config.json

C·∫•u h√¨nh c√°c database collections/tables c·∫ßn gi√°m s√°t

**C·∫•u tr√∫c m·ªói item:**

```json
{  "DATABASE_CONFIG": [    {      "name": "t√™n-database",         // T√™n ƒë·ªãnh danh      "db_type": "mongodb",           // Lo·∫°i DB: "mongodb" ho·∫∑c "postgresql"      "database": "db_name",          // T√™n database      "collection": "collection_name", // T√™n collection (MongoDB)      "table": "table_name",          // T√™n table (PostgreSQL)      "symbol_field": "symbol",       // Field ch·ª©a symbol      "datetime_field": "timestamp",  // Field ch·ª©a th·ªùi gian      "symbols": ["BTCUSDT", "..."],  // List symbols c·∫ßn check      "check_interval": 300,          // Kho·∫£ng th·ªùi gian check (gi√¢y)      "allow_delay": 90,              // ƒê·ªô tr·ªÖ cho ph√©p (gi√¢y)      "valid_schedule": "0-23"        // Gi·ªù ho·∫°t ƒë·ªông    }  ]}Gi·∫£i th√≠ch parameters:- db_type: "mongodb" ho·∫∑c "postgresql"- database: T√™n database trong h·ªá th·ªëng DB- collection: (MongoDB only) T√™n collection- table: (PostgreSQL only) T√™n table- symbol_field: T√™n field/column ch·ª©a symbol ƒë·ªÉ filter- datetime_field: T√™n field/column ch·ª©a timestamp- symbols: List symbols c·∫ßn query- check_interval: M·ªói bao nhi√™u gi√¢y query 1 l·∫ßn- allow_delay: Record c≈© qu√° bao nhi√™u gi√¢y th√¨ c·∫£nh b√°o  * L∆∞u √Ω: N√™n set >= 90s ƒë·ªÉ tr√°nh false alert do delay insert- valid_schedule: Gi·ªëng API configV√≠ d·ª• MongoDB:{  "DATABASE_CONFIG": [    {      "name": "gold-data",      "db_type": "mongodb",      "database": "trading_db",      "collection": "gold_prices",      "symbol_field": "symbol",      "datetime_field": "timestamp",      "symbols": ["XAUUSD"],      "check_interval": 60,      "allow_delay": 90,      "valid_schedule": null    }  ]}V√≠ d·ª• PostgreSQL:{  "DATABASE_CONFIG": [    {      "name": "stock-prices",      "db_type": "postgresql",      "database": "finance_db",      "table": "stock_ticks",      "symbol_field": "ticker",      "datetime_field": "trade_time",      "symbols": ["AAPL", "GOOGL", "MSFT"],      "check_interval": 300,      "allow_delay": 600,      "valid_schedule": "9-16"    }  ]}--------------------------------------------------------------------------------3.4. check_disk_config.json--------------------------------------------------------------------------------C·∫•u h√¨nh c√°c file/folder tr√™n disk c·∫ßn gi√°m s√°t th·ªùi gian thay ƒë·ªïiC·∫•u tr√∫c m·ªói item:{  "DISK_CONFIG": [    {      "name": "t√™n-file",             // T√™n ƒë·ªãnh danh      "file_path": "C:/path/to/file", // ƒê∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi ƒë·∫øn file/folder      "check_type": "mtime",          // Lo·∫°i timestamp: mtime/ctime/atime      "check_interval": 600,          // Kho·∫£ng th·ªùi gian check (gi√¢y)      "allow_delay": 3600,            // ƒê·ªô tr·ªÖ cho ph√©p (gi√¢y)      "valid_schedule": null          // Gi·ªù ho·∫°t ƒë·ªông    }  ]}Gi·∫£i th√≠ch parameters:- file_path: ƒê∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi ƒë·∫øn file ho·∫∑c folder  * Windows: "C:/Users/..." ho·∫∑c "C:Users..."  * Linux: "/home/user/..."- check_type: Lo·∫°i timestamp c·∫ßn check  * "mtime": Modification time (th·ªùi gian s·ª≠a n·ªôi dung)  * "ctime": Change time (th·ªùi gian thay ƒë·ªïi metadata)  * "atime": Access time (th·ªùi gian truy c·∫≠p g·∫ßn nh·∫•t)- check_interval: M·ªói bao nhi√™u gi√¢y check 1 l·∫ßn- allow_delay: File kh√¥ng thay ƒë·ªïi qu√° bao nhi√™u gi√¢y th√¨ c·∫£nh b√°o- valid_schedule: Gi·ªëng API configV√≠ d·ª•:{  "DISK_CONFIG": [    {      "name": "trading-log",      "file_path": "C:/logs/trading.log",      "check_type": "mtime",      "check_interval": 300,      "allow_delay": 1800,      "valid_schedule": "9-17"    },    {      "name": "data-folder",      "file_path": "/var/data/market",      "check_type": "mtime",      "check_interval": 600,      "allow_delay": 3600,      "valid_schedule": null    }  ]}L∆∞u √Ω v·ªÅ check_type:- D√πng "mtime" cho file d·ªØ li·ªáu th∆∞·ªùng xuy√™n ghi m·ªõi- D√πng "ctime" cho file metadata (permissions, ownership)- D√πng "atime" ƒë·ªÉ check xem file c√≥ ƒëang ƒë∆∞·ª£c ƒë·ªçc kh√¥ng================================================================================4. C√ÅC MODULE KI·ªÇM TRA================================================================================--------------------------------------------------------------------------------4.1. check_api.py--------------------------------------------------------------------------------Module: src/check_api/check_api.pyCh·ª©c nƒÉng:- Gi√°m s√°t API endpoints ƒë·ªÉ ki·ªÉm tra t√≠nh c·∫≠p nh·∫≠t c·ªßa d·ªØ li·ªáu- G·ª≠i GET request ƒë·∫øn API, parse JSON response- So s√°nh timestamp c·ªßa t·ª´ng symbol v·ªõi th·ªùi gian hi·ªán t·∫°i- C·∫£nh b√°o n·∫øu d·ªØ li·ªáu c≈© h∆°n allow_delayH√†m ch√≠nh:1. check_data_api(api_name, uri, record_pointer, symbol, check_interval,                   allow_delay, valid_schedule)      Parameters:   - api_name: T√™n API (ƒë·ªÉ hi·ªÉn th·ªã)   - uri: URL c·ªßa API endpoint   - record_pointer: JSON path ƒë·∫øn m·∫£ng records (vd: "data.records")   - symbol: Symbol c·∫ßn check (vd: "BTCUSDT")   - check_interval: Interval gi·ªØa c√°c l·∫ßn check (gi√¢y)   - allow_delay: Delay t·ªëi ƒëa cho ph√©p (gi√¢y)   - valid_schedule: Khung gi·ªù ho·∫°t ƒë·ªông (vd: "9-17" ho·∫∑c None)      Return: None (ch·∫°y v√¥ h·∫°n cho ƒë·∫øn khi task b·ªã cancel)      Flow:   - Loop v√¥ h·∫°n v·ªõi sleep = check_interval   - Check valid_schedule tr∆∞·ªõc khi th·ª±c hi·ªán   - GET request ƒë·∫øn URI   - Parse JSON v√† t√¨m record c·ªßa symbol   - Extract timestamp v√† so s√°nh v·ªõi now   - N·∫øu qu√° allow_delay: G·ª≠i alert qua Discord   - Handle exceptions v√† retry2. run_api_tasks()      Return: None (entry point cho API monitoring)      Flow:   - Loop v√¥ h·∫°n reload config m·ªói 10 gi√¢y   - Load check_api_config.json   - T·∫°o expected_items t·ª´ config (api_name + symbol)   - So s√°nh v·ªõi running_tasks hi·ªán t·∫°i   - Start tasks m·ªõi cho items kh√¥ng c√≥ trong running_tasks   - Cancel tasks cho items kh√¥ng c√≤n trong config   - Update running_tasks dictionaryC√°ch ho·∫°t ƒë·ªông:1. run_api_tasks() ƒë∆∞·ª£c g·ªçi t·ª´ main.py2. M·ªói 10 gi√¢y reload config v√† c·∫≠p nh·∫≠t tasks3. M·ªói (api_name, symbol) ch·∫°y trong 1 asyncio task ri√™ng4. Tasks t·ª± ƒë·ªông start/stop khi config thay ƒë·ªïiV√≠ d·ª• alert:"[PLATFORM] API binance-futures - BTCUSDTD·ªØ li·ªáu c≈© 180 gi√¢y (allow: 120s)Latest: 2025-12-04 14:30:00Current: 2025-12-04 14:33:00"--------------------------------------------------------------------------------4.2. check_database.py--------------------------------------------------------------------------------Module: src/check_database/check_database.pyCh·ª©c nƒÉng:- Gi√°m s√°t MongoDB collections v√† PostgreSQL tables- Query tr·ª±c ti·∫øp database ƒë·ªÉ l·∫•y record m·ªõi nh·∫•t c·ªßa m·ªói symbol- So s√°nh timestamp v·ªõi th·ªùi gian hi·ªán t·∫°i- C·∫£nh b√°o n·∫øu d·ªØ li·ªáu c≈© h∆°n allow_delayH√†m ch√≠nh:1. check_data_database(db_name, db_type, database, collection_or_table,                        symbol_field, datetime_field, symbol, check_interval,                       allow_delay, valid_schedule)      Parameters:   - db_name: T√™n database config (ƒë·ªÉ hi·ªÉn th·ªã)   - db_type: "mongodb" ho·∫∑c "postgresql"   - database: T√™n database   - collection_or_table: T√™n collection (Mongo) ho·∫∑c table (Postgres)   - symbol_field: Field/column ch·ª©a symbol   - datetime_field: Field/column ch·ª©a timestamp   - symbol: Symbol c·∫ßn check   - check_interval: Interval gi·ªØa c√°c l·∫ßn check (gi√¢y)   - allow_delay: Delay t·ªëi ƒëa cho ph√©p (gi√¢y)   - valid_schedule: Khung gi·ªù ho·∫°t ƒë·ªông      Return: None (ch·∫°y v√¥ h·∫°n cho ƒë·∫øn khi task b·ªã cancel)      Flow:   - Loop v√¥ h·∫°n v·ªõi sleep = check_interval   - Check valid_schedule tr∆∞·ªõc khi th·ª±c hi·ªán   - K·∫øt n·ªëi database (MongoDB ho·∫∑c PostgreSQL)   - Query record m·ªõi nh·∫•t:      * MongoDB: find_one({symbol_field: symbol}, sort=[(datetime_field, -1)])     * PostgreSQL: SELECT * WHERE symbol_field = symbol ORDER BY datetime_field DESC LIMIT 1   - Extract timestamp v√† convert timezone   - So s√°nh v·ªõi now   - N·∫øu qu√° allow_delay: G·ª≠i alert qua Discord   - Handle exceptions v√† retry2. run_database_tasks()      Return: None (entry point cho Database monitoring)      Flow:   - Loop v√¥ h·∫°n reload config m·ªói 10 gi√¢y   - Load check_database_config.json   - T·∫°o expected_items t·ª´ config (db_name + symbol)   - So s√°nh v·ªõi running_tasks hi·ªán t·∫°i   - Start tasks m·ªõi cho items kh√¥ng c√≥ trong running_tasks   - Cancel tasks cho items kh√¥ng c√≤n trong config   - Update running_tasks dictionaryDatabase Connections:- MongoDB: pymongo.MongoClient  * Connection string: mongodb://user:pass@host:port/  * Auto-reconnect on connection loss  - PostgreSQL: psycopg2.connect  * Connection params: host, port, database, user, password  * Auto-reconnect v·ªõi context managerTimezone Handling:- MongoDB: Timestamp th∆∞·ªùng UTC, convert sang local timezone- PostgreSQL: Depends on column type (timestamptz vs timestamp)- S·ª≠ d·ª•ng convert_datetime_util.py ƒë·ªÉ normalizeL∆∞u √Ω v·ªÅ allow_delay:- N√™n set >= 90 gi√¢y cho database- V√¨ c√≥ delay trong qu√° tr√¨nh insert data v√†o DB- V√≠ d·ª•: Data timestamp 14:36:00 nh∆∞ng insert xong l√∫c 14:36:10  N·∫øu check l√∫c 14:36:07 s·∫Ω th·∫•y "data c≈© 7s" l√† false alertV√≠ d·ª• alert:"[PLATFORM] Database gold-data - XAUUSD  D·ªØ li·ªáu c≈© 150 gi√¢y (allow: 90s)Latest: 2025-12-04 14:30:00Current: 2025-12-04 14:32:30"--------------------------------------------------------------------------------4.3. check_disk.py--------------------------------------------------------------------------------Module: src/check_disk/check_disk.pyCh·ª©c nƒÉng:- Gi√°m s√°t file/folder tr√™n disk ƒë·ªÉ check th·ªùi gian thay ƒë·ªïi- S·ª≠ d·ª•ng os.stat() ƒë·ªÉ l·∫•y timestamp (mtime/ctime/atime)- So s√°nh timestamp v·ªõi th·ªùi gian hi·ªán t·∫°i- C·∫£nh b√°o n·∫øu file kh√¥ng thay ƒë·ªïi qu√° allow_delayH√†m ch√≠nh:1. check_disk_file(disk_name, file_path, check_type, check_interval,                   allow_delay, valid_schedule)      Parameters:   - disk_name: T√™n config (ƒë·ªÉ hi·ªÉn th·ªã)   - file_path: ƒê∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi ƒë·∫øn file/folder   - check_type: "mtime", "ctime", ho·∫∑c "atime"   - check_interval: Interval gi·ªØa c√°c l·∫ßn check (gi√¢y)   - allow_delay: Delay t·ªëi ƒëa cho ph√©p (gi√¢y)   - valid_schedule: Khung gi·ªù ho·∫°t ƒë·ªông      Return: None (ch·∫°y v√¥ h·∫°n cho ƒë·∫øn khi task b·ªã cancel)      Flow:   - Loop v√¥ h·∫°n v·ªõi sleep = check_interval   - Check valid_schedule tr∆∞·ªõc khi th·ª±c hi·ªán   - Check file/folder existence b·∫±ng Path.exists()   - L·∫•y timestamp b·∫±ng Path.stat():     * mtime: stat.st_mtime (modification time)     * ctime: stat.st_ctime (change time)      * atime: stat.st_atime (access time)   - Convert timestamp sang datetime   - So s√°nh v·ªõi now   - N·∫øu qu√° allow_delay: G·ª≠i alert qua Discord   - Handle file not found v√† exceptions2. run_disk_tasks()      Return: None (entry point cho Disk monitoring)      Flow:   - Loop v√¥ h·∫°n reload config m·ªói 10 gi√¢y   - Load check_disk_config.json   - T·∫°o expected_items t·ª´ config (disk_name)   - So s√°nh v·ªõi running_tasks hi·ªán t·∫°i   - Start tasks m·ªõi cho items kh√¥ng c√≥ trong running_tasks   - Cancel tasks cho items kh√¥ng c√≤n trong config   - Update running_tasks dictionaryFile System Operations:- pathlib.Path: Modern Python path handling  * Path(file_path).exists(): Check file t·ªìn t·∫°i  * Path(file_path).stat(): L·∫•y file metadata  * Path(file_path).is_file(): Check l√† file hay folder- os.stat: Low-level file stats  * st_mtime: Th·ªùi gian modify n·ªôi dung file  * st_ctime: Th·ªùi gian thay ƒë·ªïi metadata (Windows: creation time)  * st_atime: Th·ªùi gian access file g·∫ßn nh·∫•tTimestamp Types:- mtime (Modification Time):   * Khi n√†o: File content thay ƒë·ªïi  * Use case: Log files, data files ƒë∆∞·ª£c append li√™n t·ª•c  * V√≠ d·ª•: trading.log ƒë∆∞·ª£c ghi m·ªói ph√∫t  - ctime (Change Time):  * Windows: File creation time  * Linux: Metadata change (permission, ownership, rename)  * Use case: Ki·ªÉm tra file m·ªõi ƒë∆∞·ª£c t·∫°o  - atime (Access Time):  * Khi n√†o: File ƒë∆∞·ª£c ƒë·ªçc/open  * Use case: Ki·ªÉm tra file c√≥ ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng  * L∆∞u √Ω: M·ªôt s·ªë OS t·∫Øt atime update ƒë·ªÉ tƒÉng performanceV√≠ d·ª• alert:"[PLATFORM] Disk trading-logFile kh√¥ng thay ƒë·ªïi 2100 gi√¢y (allow: 1800s)File: C:/logs/trading.logLast Modified: 2025-12-04 13:30:00Current: 2025-12-04 14:05:00"================================================================================5. TI·ªÜN √çCH (UTILITIES)================================================================================--------------------------------------------------------------------------------5.1. load_config_util.py--------------------------------------------------------------------------------Module: src/utils/load_config_util.pyCh·ª©c nƒÉng:- Load JSON config files v·ªõi caching th√¥ng minh- T·ª± ƒë·ªông reload khi file thay ƒë·ªïi (detect b·∫±ng mtime)- H·ªó tr·ª£ l·∫•y section c·ª• th·ªÉ ho·∫∑c to√†n b·ªô configClass: LoadConfigUtilAttributes:- _config_cache: Dict l∆∞u cache {filename: config_data}- _file_mtime_cache: Dict l∆∞u mtime {filename: timestamp}Methods:1. load_json_to_variable(filename, config_type=None)      Parameters:   - filename: T√™n file JSON (vd: "check_api_config.json")   - config_type: (Optional) Key c·ªßa section c·∫ßn l·∫•y (vd: "API_CONFIG")      Return:   - N·∫øu config_type=None: Tr·∫£ v·ªÅ to√†n b·ªô JSON object   - N·∫øu config_type c√≥ gi√° tr·ªã: Tr·∫£ v·ªÅ section t∆∞∆°ng ·ª©ng   - Raise exception n·∫øu file kh√¥ng t·ªìn t·∫°i ho·∫∑c JSON invalid      Flow:   - T·∫°o full path: configs/{filename}   - L·∫•y current mtime c·ªßa file   - N·∫øu file ch∆∞a c√≥ trong cache ho·∫∑c mtime kh√°c:     * ƒê·ªçc file v√† parse JSON     * Update cache v√† mtime_cache   - Tr·∫£ v·ªÅ to√†n b·ªô ho·∫∑c section theo config_typeV√≠ d·ª• s·ª≠ d·ª•ng:# L·∫•y to√†n b·ªô configconfig_util = LoadConfigUtil()full_config = config_util.load_json_to_variable("common_config.json")platform_config = full_config["PLATFORM_CONFIG"]mongo_config = full_config["MONGO_CONFIG"]# L·∫•y section c·ª• th·ªÉapi_configs = config_util.load_json_to_variable(    "check_api_config.json",     "API_CONFIG")Caching Strategy:- Cache based on file modification time- N·∫øu file kh√¥ng ƒë·ªïi, return t·ª´ cache (kh√¥ng ƒë·ªçc l·∫°i file)- N·∫øu file thay ƒë·ªïi (mtime kh√°c), reload v√† update cache- Gi√∫p gi·∫£m I/O khi reload config li√™n t·ª•c m·ªói 10sThread Safety:- Hi·ªán t·∫°i kh√¥ng thread-safe- N·∫øu c·∫ßn multi-threading, th√™m threading.Lock()--------------------------------------------------------------------------------5.2. convert_datetime_util.py--------------------------------------------------------------------------------Module: src/utils/convert_datetime_util.pyCh·ª©c nƒÉng:- Convert gi·ªØa c√°c ƒë·ªãnh d·∫°ng datetime kh√°c nhau- X·ª≠ l√Ω timezone conversion- Parse string datetime th√†nh datetime objectFunctions:1. convert_to_datetime(value, timezone='UTC')      Parameters:   - value: C√≥ th·ªÉ l√† datetime object, timestamp (float), ho·∫∑c string   - timezone: Timezone c·∫ßn convert (default: 'UTC')      Return: datetime object v·ªõi timezone ƒë∆∞·ª£c set      Flow:   - N·∫øu value l√† datetime object: Set timezone   - N·∫øu value l√† s·ªë (timestamp): Convert t·ª´ Unix timestamp   - N·∫øu value l√† string: Parse b·∫±ng dateutil.parser   - Apply timezone conversion      V√≠ d·ª•:   dt = convert_to_datetime("2025-12-04 14:30:00", "Asia/Ho_Chi_Minh")   dt = convert_to_datetime(1733298600, "UTC")   dt = convert_to_datetime(datetime.now(), "Asia/Tokyo")2. get_current_time(timezone='UTC')      Parameters:   - timezone: Timezone mu·ªën l·∫•y th·ªùi gian (default: 'UTC')      Return: datetime object c·ªßa th·ªùi gian hi·ªán t·∫°i v·ªõi timezone      V√≠ d·ª•:   now_utc = get_current_time()  # UTC time   now_vn = get_current_time("Asia/Ho_Chi_Minh")  # VN time3. calculate_time_diff(dt1, dt2)      Parameters:   - dt1: datetime object (th∆∞·ªùng l√† older time)   - dt2: datetime object (th∆∞·ªùng l√† current time)      Return: int (s·ªë gi√¢y ch√™nh l·ªách)      V√≠ d·ª•:   diff = calculate_time_diff(last_update, now)   if diff > allow_delay:       send_alert()Timezone Handling:- S·ª≠ d·ª•ng pytz library cho timezone conversion- M·ªôt s·ªë timezone th√¥ng d·ª•ng:  * "UTC": Coordinated Universal Time  * "Asia/Ho_Chi_Minh": Vietnam (UTC+7)  * "Asia/Tokyo": Japan (UTC+9)  * "America/New_York": US Eastern  * "Europe/London": UKString Parsing:- H·ªó tr·ª£ nhi·ªÅu format: ISO 8601, "YYYY-MM-DD HH:MM:SS", etc.- T·ª± ƒë·ªông detect format b·∫±ng dateutil.parser- Handle timezone trong string (vd: "2025-12-04T14:30:00+07:00")Database Timestamp:- MongoDB: Th∆∞·ªùng l∆∞u UTC datetime- PostgreSQL:   * timestamptz: C√≥ timezone  * timestamp: Kh√¥ng c√≥ timezone (assume UTC ho·∫∑c local)--------------------------------------------------------------------------------5.3. platform_util.py--------------------------------------------------------------------------------Module: src/utils/platform_util.pyCh·ª©c nƒÉng:- L·∫•y th√¥ng tin platform t·ª´ config- G·ª≠i alerts qua Discord webhook- X·ª≠ l√Ω holiday detection logicFunctions:1. get_platform_config()      Return: dict v·ªõi keys "WEBHOOK_URL" v√† "DESCRIPTION"      Flow:   - Load common_config.json   - Return PLATFORM_CONFIG section      V√≠ d·ª• return:   {     "WEBHOOK_URL": "https://discord.com/api/webhooks/123/abc",     "DESCRIPTION": "Production VPS"   }2. send_discord_alert(message, is_holiday_suspected=False)      Parameters:   - message: N·ªôi dung alert (string)   - is_holiday_suspected: Boolean, c√≥ ph·∫£i holiday kh√¥ng      Return: None      Flow:   - Get webhook URL t·ª´ platform config   - T·∫°o Discord embed:     * Title: "Data Staleness Alert" ho·∫∑c "Holiday Suspected"     * Color: Red (stale) ho·∫∑c Yellow (holiday)     * Description: message     * Timestamp: Current time   - POST request ƒë·∫øn Discord webhook   - Handle errors3. check_valid_schedule(schedule_str)      Parameters:   - schedule_str: String ho·∫∑c None (vd: "9-17", "0-23", None)      Return: Boolean (True n·∫øu hi·ªán t·∫°i trong schedule, False n·∫øu ngo√†i)      Flow:   - N·∫øu schedule_str is None: Return True (24/7)   - Parse schedule_str th√†nh start_hour v√† end_hour   - L·∫•y current hour   - Check: start_hour <= current_hour <= end_hour      V√≠ d·ª•:   schedule = "9-17"   if check_valid_schedule(schedule):       # Current time trong khung 9h-17h       perform_check()   else:       # Ngo√†i gi·ªù, skip check       await asyncio.sleep(check_interval)4. detect_holiday(stale_items)      Parameters:   - stale_items: List c√°c items b·ªã stale      Return: Boolean (True n·∫øu nghi ng·ªù holiday)      Logic:   - N·∫øu c√≥ >= 3 items c√πng stale: C√≥ th·ªÉ l√† holiday   - N·∫øu < 3 items: V·∫•n ƒë·ªÅ ri√™ng l·∫ª, kh√¥ng ph·∫£i holiday      Use case:   - Tr√°nh spam alerts khi to√†n b·ªô h·ªá th·ªëng offline (ng√†y l·ªÖ)   - G·ª≠i 1 alert t·ªïng h·ª£p thay v√¨ nhi·ªÅu alerts ri√™ng l·∫ªDiscord Webhook Format:{  "embeds": [{    "title": "Alert Title",    "description": "Alert message",    "color": 16711680,  // Red    "timestamp": "2025-12-04T14:30:00Z",    "footer": {      "text": "Data Monitoring System"    }  }]}================================================================================6. C√ÅCH CH·∫†Y H·ªÜ TH·ªêNG================================================================================--------------------------------------------------------------------------------6.1. C√†i ƒë·∫∑t Dependencies--------------------------------------------------------------------------------1. T·∫°o virtual environment (khuy·∫øn ngh·ªã):   python -m venv .venv   2. Activate virtual environment:   # Windows   .venvScriptsactivate      # Linux/Mac   source .venv/bin/activate3. C√†i ƒë·∫∑t packages:   pip install -r requirements.txtDependencies ch√≠nh:- asyncio: Async programming (built-in Python 3.7+)- aiohttp: Async HTTP client- requests: Sync HTTP client (backup)- pymongo: MongoDB driver- psycopg2-binary: PostgreSQL driver- pytz: Timezone handling- python-dateutil: Date parsing--------------------------------------------------------------------------------6.2. C·∫•u h√¨nh Config Files--------------------------------------------------------------------------------1. Copy v√† edit common_config.json:   - ƒêi·ªÅn webhook URL t·ª´ Discord   - ƒêi·ªÅn credentials cho MongoDB v√† PostgreSQL   - Set platform description2. T·∫°o check_api_config.json:   - Th√™m c√°c API endpoints c·∫ßn monitor   - Set check_interval v√† allow_delay ph√π h·ª£p   - Define valid_schedule n·∫øu c·∫ßn3. T·∫°o check_database_config.json:   - Th√™m c√°c database collections/tables c·∫ßn monitor   - L∆∞u √Ω: allow_delay n√™n >= 90s   - Test k·∫øt n·ªëi database tr∆∞·ªõc4. T·∫°o check_disk_config.json:   - Th√™m c√°c file/folder paths c·∫ßn monitor   - Check file paths t·ªìn t·∫°i tr∆∞·ªõc khi ch·∫°y   - Ch·ªçn check_type ph√π h·ª£p (mtime/ctime/atime)--------------------------------------------------------------------------------6.3. Ch·∫°y H·ªá Th·ªëng--------------------------------------------------------------------------------Method 1: Ch·∫°y tr·ª±c ti·∫øppython src/main.pyMethod 2: Ch·∫°y trong background (Linux)nohup python src/main.py > output.log 2>&1 &Method 3: Ch·∫°y nh∆∞ service (systemd Linux)# T·∫°o file /etc/systemd/system/data-monitor.service[Unit]Description=Data Monitoring SystemAfter=network.target[Service]Type=simpleUser=your_userWorkingDirectory=/path/to/check_data_projectExecStart=/path/to/.venv/bin/python src/main.pyRestart=always[Install]WantedBy=multi-user.target# Enable v√† start servicesudo systemctl enable data-monitorsudo systemctl start data-monitorsudo systemctl status data-monitorMethod 4: Docker (n·∫øu c√≥ Dockerfile)docker build -t data-monitor .docker run -d --name data-monitor data-monitor--------------------------------------------------------------------------------6.4. Monitoring v√† Debug--------------------------------------------------------------------------------Logs:- stdout: Th√¥ng tin ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng- stderr: Errors v√† warnings- Discord: Alerts khi data staleDebug mode:- Set logging level trong logging_config.py- Add print statements trong c√°c check functions- Monitor Discord channel ƒë·ªÉ xem alertsTest m·ªôt checker:# Test API checker only# Comment out database_task v√† disk_task trong main.py# Test v·ªõi 1 item duy nh·∫•t# X√≥a t·∫°m c√°c items kh√°c trong config fileTroubleshooting:- "Connection refused": Check database credentials- "File not found": Verify ƒë∆∞·ªùng d·∫´n file trong disk config- "Import error": Reinstall dependencies- "Webhook failed": Check Discord webhook URL================================================================================7. DYNAMIC CONFIG RELOAD================================================================================H·ªá th·ªëng h·ªó tr·ª£ reload config ƒë·ªông m·ªói 10 gi√¢y m√† kh√¥ng c·∫ßn restart.--------------------------------------------------------------------------------7.1. C√°ch Ho·∫°t ƒê·ªông--------------------------------------------------------------------------------M·ªói checker module (API, Database, Disk) c√≥ 1 main loop:while True:    # 1. Load config t·ª´ JSON file    config = load_config_from_json()        # 2. T·∫°o list expected items t·ª´ config    expected_items = extract_items_from_config(config)        # 3. So s√°nh v·ªõi running tasks hi·ªán t·∫°i    new_items = expected_items - running_tasks.keys()    removed_items = running_tasks.keys() - expected_items        # 4. Start tasks cho items m·ªõi    for item in new_items:        task = asyncio.create_task(check_function(item_params))        running_tasks[item] = task        # 5. Cancel tasks cho items ƒë√£ x√≥a    for item in removed_items:        running_tasks[item].cancel()        del running_tasks[item]        # 6. ƒê·ª£i 10 gi√¢y r·ªìi reload l·∫°i    await asyncio.sleep(10)--------------------------------------------------------------------------------7.2. Config Change Detection--------------------------------------------------------------------------------LoadConfigUtil t·ª± ƒë·ªông detect file changes:- Cache file content v√† modification time (mtime)- M·ªói l·∫ßn load, check mtime hi·ªán t·∫°i vs cached mtime- N·∫øu kh√°c nhau: Reload file v√† update cache- N·∫øu gi·ªëng nhau: Return t·ª´ cache (kh√¥ng ƒë·ªçc file)ƒêi·ªÅu n√†y c√≥ nghƒ©a:1. Edit b·∫•t k·ª≥ config file n√†o2. Save file3. Trong v√≤ng 10 gi√¢y, h·ªá th·ªëng s·∫Ω:   - Detect file mtime thay ƒë·ªïi   - Reload config m·ªõi   - Start/stop tasks t∆∞∆°ng ·ª©ng--------------------------------------------------------------------------------7.3. Use Cases--------------------------------------------------------------------------------1. Th√™m API endpoint m·ªõi:   - Edit check_api_config.json   - Th√™m 1 object m·ªõi v√†o "API_CONFIG" array   - Save file   - Trong 10s: Task m·ªõi s·∫Ω ƒë∆∞·ª£c t·∫°o v√† start2. X√≥a database monitoring:   - Edit check_database_config.json   - X√≥a object t∆∞∆°ng ·ª©ng kh·ªèi "DATABASE_CONFIG" array   - Save file   - Trong 10s: Task s·∫Ω b·ªã cancel v√† x√≥a kh·ªèi running_tasks3. Thay ƒë·ªïi parameters:   - Edit config file (vd: tƒÉng allow_delay t·ª´ 60 ‚Üí 90)   - Save file   - L∆∞u √Ω: Task c≈© s·∫Ω b·ªã cancel v√† task m·ªõi ƒë∆∞·ª£c t·∫°o   - C√≥ th·ªÉ m·∫•t 1 check_interval tr∆∞·ªõc khi params m·ªõi c√≥ hi·ªáu l·ª±c4. Update credentials:   - Edit common_config.json   - Update MONGO_CONFIG ho·∫∑c POSTGRE_CONFIG   - Save file   - Database tasks s·∫Ω d√πng credentials m·ªõi ·ªü l·∫ßn connect ti·∫øp theo--------------------------------------------------------------------------------7.4. Limitations--------------------------------------------------------------------------------- Config reload interval: 10 gi√¢y (hard-coded)  * C√≥ th·ªÉ gi·∫£m xu·ªëng nh∆∞ng s·∫Ω tƒÉng I/O  * Kh√¥ng n√™n < 5 gi√¢y- Task restart overhead:  * Khi config thay ƒë·ªïi, task c≈© b·ªã cancel ngay  * Task m·ªõi start v√† ph·∫£i ch·ªù check_interval ƒë·∫ßu ti√™n  * C√≥ th·ªÉ miss 1 check cycle- No hot-reload for code:  * Ch·ªâ reload config, kh√¥ng reload Python code  * N·∫øu s·ª≠a code trong check_api.py, ph·∫£i restart to√†n b·ªô- File lock:  * N·∫øu ƒëang edit config file, c√≥ th·ªÉ g·∫∑p l·ªói khi system ƒë·ªçc  * N√™n d√πng atomic write (write to temp file then rename)================================================================================8. TASK LIFECYCLE MANAGEMENT================================================================================--------------------------------------------------------------------------------8.1. Task Creation--------------------------------------------------------------------------------M·ªói monitoring item t·∫°o 1 asyncio task ri√™ng:# API examplefor api_config in API_CONFIG:    for symbol in api_config["symbols"]:        item_key = f"{api_config['name']}_{symbol}"        task = asyncio.create_task(            check_data_api(                api_name=api_config["name"],                uri=api_config["uri"],                record_pointer=api_config["record_pointer"],                symbol=symbol,                check_interval=api_config["check_interval"],                allow_delay=api_config["allow_delay"],                valid_schedule=api_config["valid_schedule"]            )        )        running_tasks[item_key] = taskItem key format:- API: f"{api_name}_{symbol}"- Database: f"{db_name}_{symbol}"- Disk: f"{disk_name}" (kh√¥ng c√≥ symbol)--------------------------------------------------------------------------------8.2. Task Cancellation--------------------------------------------------------------------------------Khi item b·ªã x√≥a kh·ªèi config:if item_key in running_tasks:    task = running_tasks[item_key]    task.cancel()  # Send CancelledError to task    try:        await task  # Wait for task to finish cleanup    except asyncio.CancelledError:        pass  # Expected, task was cancelled    del running_tasks[item_key]Task cleanup:- asyncio.CancelledError ƒë∆∞·ª£c raise trong task- Task c√≥ th·ªÉ catch exception v√† cleanup resources- Finally blocks s·∫Ω ƒë∆∞·ª£c execute--------------------------------------------------------------------------------8.3. Running Tasks Dictionary--------------------------------------------------------------------------------Structure:running_tasks = {    "binance-futures_BTCUSDT": <Task object>,    "binance-futures_ETHUSDT": <Task object>,    "gold-data_XAUUSD": <Task object>,    "trading-log": <Task object>,    ...}Operations:- Add: running_tasks[key] = task- Remove: del running_tasks[key]- Check: if key in running_tasks- Iterate: for key, task in running_tasks.items()Thread safety:- asyncio tasks ch·∫°y trong single thread (event loop)- Kh√¥ng c·∫ßn lock cho running_tasks dict- N·∫øu d√πng multi-threading: C·∫ßn asyncio.Lock()--------------------------------------------------------------------------------8.4. Task States--------------------------------------------------------------------------------Asyncio task c√≥ c√°c states:1. Pending: Task ƒë√£ t·∫°o nh∆∞ng ch∆∞a ch·∫°y2. Running: Task ƒëang execute3. Done: Task completed ho·∫∑c raised exception4. Cancelled: Task b·ªã cancelCheck task state:if task.done():    if task.cancelled():        print("Task was cancelled")    else:        try:            result = task.result()        except Exception as e:            print(f"Task raised: {e}")--------------------------------------------------------------------------------8.5. Exception Handling--------------------------------------------------------------------------------Task exceptions kh√¥ng crash to√†n b·ªô program:async def check_data_api(...):    while True:        try:            # Perform check            response = await fetch_api(uri)            # Process data        except asyncio.CancelledError:            print(f"Task {api_name}_{symbol} cancelled")            break  # Exit loop        except Exception as e:            print(f"Error in {api_name}_{symbol}: {e}")            # Continue loop, retry next interval                await asyncio.sleep(check_interval)Best practices:- Always catch asyncio.CancelledError separately- Log exceptions but don't crash- Retry on transient errors (network, timeout)- Alert on persistent errors================================================================================9. H·ªÜ TH·ªêNG C·∫¢NH B√ÅO================================================================================--------------------------------------------------------------------------------9.1. Discord Webhook--------------------------------------------------------------------------------H·ªá th·ªëng s·ª≠ d·ª•ng Discord webhooks ƒë·ªÉ g·ª≠i alerts.Setup webhook:1. V√†o Discord server ‚Üí Server Settings ‚Üí Integrations2. Click "Create Webhook"3. Ch·ªçn channel nh·∫≠n alerts4. Copy webhook URL5. Paste v√†o common_config.jsonWebhook URL format:https://discord.com/api/webhooks/{webhook_id}/{webhook_token}--------------------------------------------------------------------------------9.2. Alert Format--------------------------------------------------------------------------------Normal alert (1 item stale):‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ üî¥ Data Staleness Alert                ‚îÇ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÇ [Production VPS] API binance-futures   ‚îÇ‚îÇ Symbol: BTCUSDT                         ‚îÇ‚îÇ                                         ‚îÇ‚îÇ D·ªØ li·ªáu c≈©: 180 gi√¢y                   ‚îÇ‚îÇ Allow delay: 120 gi√¢y                   ‚îÇ‚îÇ                                         ‚îÇ‚îÇ Latest: 2025-12-04 14:30:00            ‚îÇ‚îÇ Current: 2025-12-04 14:33:00           ‚îÇ‚îÇ                                         ‚îÇ‚îÇ ‚è∞ 2025-12-04 14:33:00 UTC              ‚îÇ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îòHoliday suspected alert (‚â•3 items stale):‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ ‚ö†Ô∏è Holiday Suspected                    ‚îÇ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÇ [Production VPS] Multiple items stale  ‚îÇ‚îÇ                                         ‚îÇ‚îÇ Stale items (5):                        ‚îÇ‚îÇ - binance-futures BTCUSDT               ‚îÇ‚îÇ - binance-futures ETHUSDT               ‚îÇ‚îÇ - gold-data XAUUSD                      ‚îÇ‚îÇ - trading-log                           ‚îÇ‚îÇ - stock-prices AAPL                     ‚îÇ‚îÇ                                         ‚îÇ‚îÇ ‚è∞ 2025-12-04 14:33:00 UTC              ‚îÇ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò--------------------------------------------------------------------------------9.3. Alert Throttling--------------------------------------------------------------------------------Tr√°nh spam alerts:# Trong check functionlast_alert_time = Nonealert_interval = 3600  # Ch·ªâ alert m·ªói 1 gi·ªùif data_is_stale:    now = time.time()    if last_alert_time is None or now - last_alert_time > alert_interval:        send_discord_alert(message)        last_alert_time = nowStrategies:1. Time-based: Ch·ªâ alert m·ªói X gi√¢y2. State-change: Ch·ªâ alert khi chuy·ªÉn t·ª´ OK ‚Üí Stale3. Escalation: Alert ngay, r·ªìi sau ƒë√≥ m·ªói 1h--------------------------------------------------------------------------------9.4. Holiday Detection--------------------------------------------------------------------------------Logic:- M·ªói checker collect danh s√°ch items ƒëang stale- N·∫øu >= 3 items c√πng stale: Nghi ng·ªù holiday- G·ª≠i 1 alert t·ªïng h·ª£p thay v√¨ nhi·ªÅu alerts ri√™ng l·∫ªImplementation:stale_items = []# Trong loop qua t·∫•t c·∫£ itemsfor item in items:    if item_is_stale:        stale_items.append(item)# Sau khi check h·∫øtif len(stale_items) >= 3:    send_holiday_alert(stale_items)else:    for item in stale_items:        send_individual_alert(item)Benefits:- Gi·∫£m alert spam khi to√†n b·ªô market ƒë√≥ng c·ª≠a- D·ªÖ nh·∫≠n di·ªán holiday vs technical issues- T·∫≠p trung notification v√†o 1 message================================================================================10. Y√äU C·∫¶U H·ªÜ TH·ªêNG================================================================================--------------------------------------------------------------------------------10.1. Python Version--------------------------------------------------------------------------------- Python 3.7 tr·ªü l√™n (v√¨ asyncio features)- Khuy·∫øn ngh·ªã: Python 3.9+ (stable async/await)- Tested on: Python 3.10--------------------------------------------------------------------------------10.2. Operating System--------------------------------------------------------------------------------- Windows: Tested ‚úì- Linux: Compatible ‚úì- macOS: Compatible ‚úìL∆∞u √Ω v·ªÅ file paths:- Windows: "C:/path/to/file" ho·∫∑c "C:pathtofile"- Linux/Mac: "/path/to/file"- S·ª≠ d·ª•ng pathlib.Path() ƒë·ªÉ handle cross-platform--------------------------------------------------------------------------------10.3. Network Requirements--------------------------------------------------------------------------------- Internet connection (ƒë·ªÉ g·ªçi APIs v√† Discord webhook)- Firewall cho ph√©p:  * Outbound HTTP/HTTPS (port 80, 443)  * Outbound MongoDB (port 27017 n·∫øu d√πng)  * Outbound PostgreSQL (port 5432 n·∫øu d√πng)--------------------------------------------------------------------------------10.4. Database Requirements--------------------------------------------------------------------------------MongoDB (n·∫øu d√πng):- MongoDB 4.0+- User c√≥ quy·ªÅn read collections c·∫ßn monitor- Network access t·ª´ machine ch·∫°y checkerPostgreSQL (n·∫øu d√πng):- PostgreSQL 10+- User c√≥ quy·ªÅn SELECT tables c·∫ßn monitor- Network access t·ª´ machine ch·∫°y checker--------------------------------------------------------------------------------10.5. Disk Space--------------------------------------------------------------------------------- Code: < 10 MB- Logs: Depends on log retention- Virtual environment: ~50-100 MB--------------------------------------------------------------------------------10.6. Memory--------------------------------------------------------------------------------- Base: ~50 MB- Per task: ~1-2 MB- Estimate: 50 + (number_of_tasks * 2) MBExample:- 10 API checks + 5 DB checks + 3 disk checks = 18 tasks- Memory: 50 + (18 * 2) = ~86 MB--------------------------------------------------------------------------------10.7. CPU--------------------------------------------------------------------------------- Minimal CPU usage- Mostly I/O bound (network, disk)- 1 CPU core ƒë·ªß cho < 100 tasks- Async design = non-blocking================================================================================PH·ª§ L·ª§C================================================================================--------------------------------------------------------------------------------A. V√≠ D·ª• Complete Config--------------------------------------------------------------------------------common_config.json:{  "PLATFORM_CONFIG": {    "WEBHOOK_URL": "https://discord.com/api/webhooks/123456789/abcdefg",    "DESCRIPTION": "Production Server"  },  "MONGO_CONFIG": {    "host": "localhost",    "port": 27017,    "database": "trading_db",    "username": "monitor_user",    "password": "secure_password"  },  "POSTGRE_CONFIG": {    "host": "localhost",    "port": 5432,    "database": "finance_db",    "user": "monitor_user",    "password": "secure_password"  }}check_api_config.json:{  "API_CONFIG": [    {      "name": "binance-futures",      "uri": "https://api.binance.com/fapi/v1/ticker/24hr",      "record_pointer": "",      "symbols": ["BTCUSDT", "ETHUSDT"],      "check_interval": 60,      "allow_delay": 120,      "valid_schedule": null    }  ]}check_database_config.json:{  "DATABASE_CONFIG": [    {      "name": "gold-data",      "db_type": "mongodb",      "database": "trading_db",      "collection": "gold_prices",      "symbol_field": "symbol",      "datetime_field": "timestamp",      "symbols": ["XAUUSD"],      "check_interval": 60,      "allow_delay": 90,      "valid_schedule": null    }  ]}check_disk_config.json:{  "DISK_CONFIG": [    {      "name": "trading-log",      "file_path": "C:/logs/trading.log",      "check_type": "mtime",      "check_interval": 300,      "allow_delay": 1800,      "valid_schedule": "9-17"    }  ]}--------------------------------------------------------------------------------B. Troubleshooting Common Issues--------------------------------------------------------------------------------Issue: "ModuleNotFoundError: No module named 'pymongo'"Solution: pip install pymongoIssue: "Connection refused to MongoDB"Solution: - Check MongoDB ƒëang ch·∫°y: sudo systemctl status mongodb- Check host/port trong config- Check firewall rulesIssue: "Discord webhook returns 404"Solution:- Verify webhook URL- Check webhook ch∆∞a b·ªã delete trong Discord- Regenerate webhook n·∫øu c·∫ßnIssue: "File not found" cho disk checkSolution:- Verify file path t·ªìn t·∫°i- Check permissions (read access)- S·ª≠ d·ª•ng absolute path, kh√¥ng d√πng relative pathIssue: "Tasks kh√¥ng cancel khi x√≥a kh·ªèi config"Solution:- Check config file format (valid JSON)- Check file ƒë∆∞·ª£c save ƒë√∫ng c√°ch- Wait 10 seconds cho reload cycleIssue: "Timezone incorrect"Solution:- Install pytz: pip install pytz- Check timezone string trong convert_datetime_util- Verify database timezone settings--------------------------------------------------------------------------------C. Performance Tuning--------------------------------------------------------------------------------T·ªëi ∆∞u check_interval:- API: 30-60s cho real-time data, 300s cho slow-changing data- Database: 60-300s (query cost cao h∆°n API)- Disk: 300-600s (file system access √≠t thay ƒë·ªïi)T·ªëi ∆∞u allow_delay:- API: 60-120s (API th∆∞·ªùng fresh)- Database: 90-180s (c√≥ insert delay)- Disk: 1800-3600s (file c√≥ th·ªÉ kh√¥ng thay ƒë·ªïi th∆∞·ªùng xuy√™n)Reduce Discord spam:- Implement alert throttling- Use holiday detection- Group related alertsScale to more items:- Async design: 100+ tasks OK- N·∫øu > 500 tasks: Consider sharding (multiple instances)- Monitor memory usage v·ªõi nhi·ªÅu tasksDatabase connection pooling:- Reuse connections thay v√¨ connect m·ªói l·∫ßn- Implement connection pool trong database_config.py--------------------------------------------------------------------------------D. Security Best Practices--------------------------------------------------------------------------------1. Config files:   - Kh√¥ng commit credentials v√†o git   - Add configs/*.json v√†o .gitignore   - S·ª≠ d·ª•ng environment variables cho sensitive data2. Database credentials:   - T·∫°o user ri√™ng ch·ªâ c√≥ quy·ªÅn read   - Kh√¥ng d√πng root/admin user   - Rotate passwords ƒë·ªãnh k·ª≥3. Discord webhook:   - Restrict webhook permissions trong Discord   - Kh√¥ng share webhook URL c√¥ng khai   - Regenerate n·∫øu b·ªã leak4. File permissions:   - chmod 600 cho config files (owner read/write only)   - Kh√¥ng ƒë·ªÉ world-readable credentials5. Network:   - S·ª≠ d·ª•ng SSL/TLS cho database connections   - Whitelist IPs n·∫øu c√≥ th·ªÉ   - Use VPN cho production databases--------------------------------------------------------------------------------E. Future Enhancements--------------------------------------------------------------------------------C√≥ th·ªÉ m·ªü r·ªông:1. Web dashboard ƒë·ªÉ xem status real-time2. Support th√™m alert channels (Telegram, Email, Slack)3. Metrics v√† visualization (Grafana, Prometheus)4. Config hot-reload nhanh h∆°n (file watch instead of polling)5. Health check endpoint cho monitoring tools6. Database connection pooling7. Retry v·ªõi exponential backoff8. Alert aggregation v√† deduplication9. Multi-tenancy support (nhi·ªÅu platforms)10. RESTful API ƒë·ªÉ manage config qua HTTP================================================================================K·∫æT LU·∫¨N================================================================================H·ªá th·ªëng Data Monitoring cung c·∫•p gi·∫£i ph√°p to√†n di·ªán ƒë·ªÉ gi√°m s√°t t√≠nh c·∫≠pnh·∫≠t c·ªßa d·ªØ li·ªáu t·ª´ nhi·ªÅu ngu·ªìn kh√°c nhau. V·ªõi thi·∫øt k·∫ø async, dynamic configreload, v√† task lifecycle management t·ª± ƒë·ªông, h·ªá th·ªëng c√≥ th·ªÉ scale t·ªët v√†d·ªÖ d√†ng maintain.Li√™n h·ªá h·ªó tr·ª£: [Th√™m contact info]Repository: [Th√™m git URL]Last updated: 2025-12-04
```